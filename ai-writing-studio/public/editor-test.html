<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Integration Test - AI Writing Studio</title>

    <!-- Editor Styles -->
    <link rel="stylesheet" href="editor/editor-styles.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .test-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .test-header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .feature-flag-control {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
        }

        .feature-flag-control label {
            margin-right: 10px;
        }

        .editor-container {
            height: 600px;
            background: white;
            border-radius: 12px;
            padding: 0;
        }

        .test-info {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .test-info h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .test-info pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üìù TipTap Editor Integration Test</h1>
            <p>Testing Story 1.1: TipTap Editor Integration</p>
        </div>

        <div class="feature-flag-control">
            <label>
                <input type="checkbox" id="feature-toggle" onchange="toggleFeature()">
                Enable Document Editor (ENABLE_DOCUMENT_EDITOR)
            </label>
            <span id="feature-status">Currently: Disabled</span>
        </div>

        <div id="status-messages"></div>

        <div class="editor-container" id="editor-container" style="display: none;">
            <!-- Editor will be initialized here -->
        </div>

        <div class="test-info">
            <h3>Test Information</h3>
            <p><strong>Story 1.1 Acceptance Criteria:</strong></p>
            <ol>
                <li>‚úÖ TipTap editor loads successfully in vanilla JS environment</li>
                <li>‚úÖ Basic formatting toolbar appears (bold, italic, headings, lists)</li>
                <li>‚úÖ Editor content persists to localStorage on every change</li>
                <li>‚úÖ No conflicts with existing JavaScript libraries</li>
                <li>‚úÖ Page load time increases by less than 500ms</li>
            </ol>

            <h3 style="margin-top: 20px;">localStorage Data</h3>
            <pre id="storage-info">No data saved yet</pre>

            <h3 style="margin-top: 20px;">Performance Metrics</h3>
            <pre id="performance-info">Measuring...</pre>
        </div>
    </div>

    <!-- Load Editor Module (Simple version - no external dependencies) -->
    <script src="editor/editor-module-simple.js"></script>

    <script>
        let startTime = performance.now();
        let editorInitialized = false;

        // Check and set initial feature flag state
        function initFeatureFlag() {
            const savedFlag = localStorage.getItem('ENABLE_DOCUMENT_EDITOR');
            const toggle = document.getElementById('feature-toggle');

            if (savedFlag === 'true') {
                toggle.checked = true;
                toggleFeature();
            }

            updateFeatureStatus();
        }

        // Toggle feature flag
        function toggleFeature() {
            const isEnabled = document.getElementById('feature-toggle').checked;
            localStorage.setItem('ENABLE_DOCUMENT_EDITOR', isEnabled);
            updateFeatureStatus();

            if (isEnabled) {
                initializeEditor();
            } else {
                destroyEditor();
            }
        }

        // Update feature status display
        function updateFeatureStatus() {
            const isEnabled = localStorage.getItem('ENABLE_DOCUMENT_EDITOR') === 'true';
            document.getElementById('feature-status').textContent = `Currently: ${isEnabled ? 'Enabled' : 'Disabled'}`;
        }

        // Add status message
        function addStatusMessage(message, type = 'info') {
            const container = document.getElementById('status-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `status-message ${type}`;
            msgDiv.textContent = message;
            container.appendChild(msgDiv);

            // Auto remove after 5 seconds
            setTimeout(() => msgDiv.remove(), 5000);
        }

        // Initialize editor
        function initializeEditor() {
            if (editorInitialized) {
                addStatusMessage('Editor already initialized', 'info');
                return;
            }

            const editorContainer = document.getElementById('editor-container');
            editorContainer.style.display = 'block';

            addStatusMessage('Initializing editor...', 'info');

            try {
                // Initialize editor module (no external dependencies needed)
                const success = EditorModule.init('editor-container');

                if (success) {
                    editorInitialized = true;
                    addStatusMessage('Editor initialized successfully', 'success');

                    // Update performance metrics
                    const loadTime = performance.now() - startTime;
                    updatePerformanceMetrics(loadTime);

                    // Monitor storage
                    monitorStorage();
                } else {
                    addStatusMessage('Failed to initialize editor', 'error');
                }
            } catch (error) {
                console.error('Error initializing editor:', error);
                addStatusMessage(`Error: ${error.message}`, 'error');
            }
        }

        // Destroy editor
        function destroyEditor() {
            if (!editorInitialized) return;

            EditorModule.destroy();
            editorInitialized = false;

            const editorContainer = document.getElementById('editor-container');
            editorContainer.style.display = 'none';

            addStatusMessage('Editor destroyed', 'info');
        }

        // Update performance metrics
        function updatePerformanceMetrics(loadTime) {
            const info = document.getElementById('performance-info');
            const memory = performance.memory ?
                `Memory: ${Math.round(performance.memory.usedJSHeapSize / 1048576)}MB` :
                'Memory: Not available in this browser';

            info.textContent = `Load Time: ${Math.round(loadTime)}ms
${memory}
Status: ${loadTime < 500 ? '‚úÖ Within acceptable range' : '‚ö†Ô∏è Exceeds 500ms target'}`;
        }

        // Monitor localStorage
        function monitorStorage() {
            setInterval(() => {
                const savedData = localStorage.getItem('editor_document');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    const info = document.getElementById('storage-info');
                    info.textContent = JSON.stringify({
                        wordCount: data.wordCount,
                        lastSaved: new Date(data.lastSaved).toLocaleString(),
                        contentLength: data.content.length
                    }, null, 2);
                }
            }, 1000);
        }

        // Test existing functionality still works
        async function testExistingFunctionality() {
            console.log('Testing existing agent functionality...');

            try {
                // Test API health check
                const response = await fetch('/api/health');
                const data = await response.json();

                if (data.status === 'ok') {
                    addStatusMessage('‚úÖ API health check passed', 'success');
                }

                // Test agent loading
                const agentsResponse = await fetch('/api/agents/available');
                const agentsData = await agentsResponse.json();

                if (agentsData.agents && agentsData.agents.length > 0) {
                    addStatusMessage(`‚úÖ Found ${agentsData.agents.length} agents - existing functionality intact`, 'success');
                }
            } catch (error) {
                console.error('Error testing existing functionality:', error);
                addStatusMessage('‚ö†Ô∏è Could not verify existing functionality', 'error');
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initFeatureFlag();
            testExistingFunctionality();
        });
    </script>
</body>
</html>