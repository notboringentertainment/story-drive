<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #5a67d8;
        }
        #output {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .test-passed {
            color: green;
        }
        .test-failed {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Context Passing Test</h1>
    <p>This page tests if the EditorModule context functions work correctly.</p>

    <div id="editor-content" contenteditable="true" style="border: 2px solid #ddd; padding: 20px; min-height: 150px; margin: 20px 0;">
        <p>This is a test. The story I'm writing is about a man trying his best to build the greatest writing ecosystem ever known to man. Will he succeed? will he fail? will anyone even care.</p>
    </div>

    <div>
        <button onclick="testGetContent()">Test getContent()</button>
        <button onclick="testGetSelectedText()">Test getSelectedText()</button>
        <button onclick="testGetCurrentParagraph()">Test getCurrentParagraph()</button>
        <button onclick="initEditor()">Initialize Editor Module</button>
    </div>

    <div id="output"></div>

    <script src="editor/editor-module-simple.js"></script>
    <script>
        const output = document.getElementById('output');

        function log(message, isError = false) {
            const className = isError ? 'test-failed' : 'test-passed';
            output.innerHTML += `<div class="${className}">${message}</div>\n`;
            console.log(message);
        }

        function initEditor() {
            // Enable the feature flag
            localStorage.setItem('ENABLE_DOCUMENT_EDITOR', 'true');

            // Create a wrapper div
            const wrapper = document.createElement('div');
            wrapper.id = 'test-wrapper';
            document.getElementById('editor-content').parentNode.replaceChild(wrapper, document.getElementById('editor-content'));

            // Initialize the editor
            const result = EditorModule.init('test-wrapper');

            if (result) {
                log('✅ Editor initialized successfully');

                // Make it globally accessible
                window.EditorModule = EditorModule;

                // Wait a bit then test
                setTimeout(() => {
                    // Put some test content
                    const editorDiv = document.getElementById('editor-content');
                    if (editorDiv) {
                        editorDiv.innerHTML = '<p>This is a test. The story I\'m writing is about a man trying his best to build the greatest writing ecosystem ever known to man. Will he succeed? will he fail? will anyone even care.</p>';
                    }
                }, 500);
            } else {
                log('❌ Failed to initialize editor', true);
            }
        }

        function testGetContent() {
            if (!window.EditorModule) {
                log('❌ EditorModule not found. Click "Initialize Editor Module" first.', true);
                return;
            }

            const content = EditorModule.getContent();

            if (content) {
                log('✅ getContent() works!');
                log(`   HTML: ${content.html ? content.html.substring(0, 100) + '...' : 'none'}`);
                log(`   Text: ${content.text ? content.text.substring(0, 100) + '...' : 'none'}`);
                log(`   Word Count: ${content.wordCount || 0}`);
            } else {
                log('❌ getContent() returned null', true);
            }
        }

        function testGetSelectedText() {
            if (!window.EditorModule) {
                log('❌ EditorModule not found. Click "Initialize Editor Module" first.', true);
                return;
            }

            // First select some text
            log('ℹ️ Please select some text in the editor above, then click this button again');

            const selectedText = EditorModule.getSelectedText();

            if (selectedText) {
                log('✅ getSelectedText() works!');
                log(`   Selected: "${selectedText}"`);
            } else {
                log('⚠️ No text selected (or getSelectedText() not working)');
            }
        }

        function testGetCurrentParagraph() {
            if (!window.EditorModule) {
                log('❌ EditorModule not found. Click "Initialize Editor Module" first.', true);
                return;
            }

            log('ℹ️ Click somewhere in the editor text first');

            const paragraph = EditorModule.getCurrentParagraph();

            if (paragraph) {
                log('✅ getCurrentParagraph() works!');
                log(`   Paragraph: "${paragraph}"`);
            } else {
                log('⚠️ No paragraph found (or getCurrentParagraph() not working)');
            }
        }

        // Auto-initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            log('Page loaded. Click "Initialize Editor Module" to start testing.');
        });
    </script>
</body>
</html>